# *******************************************************************************
# Copyright (c) 2025 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0
#
# SPDX-License-Identifier: Apache-2.0
# *******************************************************************************
name: Release scorex CLI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to use for test release (e.g., 0.1.0-test)'
        required: false
        default: '0.0.0-test'
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - 'scorex/**'
      - '.github/workflows/release.yml'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true

      - name: Run Gazelle
        run: bazel run //:gazelle

      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [ -n "${{ github.ref }}" ]; then
            # Release from tag
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG=${GITHUB_REF#refs/tags/}
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual test release
            VERSION="${{ github.event.inputs.version }}"
            TAG="test-${VERSION}"
          else
            # PR test release
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="pr-${{ github.event.pull_request.number }}-${SHORT_SHA}"
            TAG="test-${VERSION}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build scorex for all platforms
        run: |
          echo "Current directory: $(pwd)"
          echo "Building all platforms..."
          VERSION=${{ steps.version.outputs.VERSION }} bazel build \
            //scorex:scorex_linux_amd64 \
            //scorex:scorex_darwin_arm64 \
            //scorex:scorex_darwin_amd64 \
            //scorex:scorex_windows_amd64
          echo "Build complete. Exit code: $?"

      - name: Debug bazel output
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Listing current directory ==="
          ls -la
          echo "=== Checking for bazel-bin symlink ==="
          ls -la | grep bazel || echo "No bazel symlinks found"
          echo "=== Searching for bazel output ==="
          find . -type d -name "bazel-bin" 2>/dev/null || echo "bazel-bin directory not found"
          echo "=== Searching for scorex binaries ==="
          find . -name "scorex_linux_amd64" -type f 2>/dev/null || echo "No Linux binary found"

      - name: Prepare release artifacts
        run: |
          mkdir -p release
          
          # Use bazel cquery to find actual output paths (bazel-bin symlink is cleared for multi-platform builds)
          echo "Finding binary locations..."
          LINUX_BIN=$(bazel cquery --output=files //scorex:scorex_linux_amd64 2>/dev/null)
          DARWIN_ARM64_BIN=$(bazel cquery --output=files //scorex:scorex_darwin_arm64 2>/dev/null)
          DARWIN_AMD64_BIN=$(bazel cquery --output=files //scorex:scorex_darwin_amd64 2>/dev/null)
          WINDOWS_BIN=$(bazel cquery --output=files //scorex:scorex_windows_amd64 2>/dev/null)
          
          echo "Linux binary: $LINUX_BIN"
          echo "macOS ARM64 binary: $DARWIN_ARM64_BIN"
          echo "macOS AMD64 binary: $DARWIN_AMD64_BIN"
          echo "Windows binary: $WINDOWS_BIN"
          
          # Copy binaries
          if [ -f "$LINUX_BIN" ]; then
            cp "$LINUX_BIN" release/scorex-linux-x86_64
            echo "✓ Linux binary copied"
          else
            echo "ERROR: Linux binary not found at $LINUX_BIN"
            exit 1
          fi

          if [ -f "$DARWIN_ARM64_BIN" ]; then
            cp "$DARWIN_ARM64_BIN" release/scorex-macos-arm64
            echo "✓ macOS ARM64 binary copied"
          else
            echo "ERROR: macOS ARM64 binary not found"
            exit 1
          fi

          if [ -f "$DARWIN_AMD64_BIN" ]; then
            cp "$DARWIN_AMD64_BIN" release/scorex-macos-x86_64
            echo "✓ macOS AMD64 binary copied"
          else
            echo "ERROR: macOS AMD64 binary not found"
            exit 1
          fi

          if [ -f "$WINDOWS_BIN" ]; then
            cp "$WINDOWS_BIN" release/scorex-windows-x86_64.exe
            echo "✓ Windows binary copied"
          else
            echo "ERROR: Windows binary not found"
            exit 1
          fi

          # Create compressed archives
          cd release
          tar -czf scorex-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz scorex-linux-x86_64
          tar -czf scorex-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz scorex-macos-arm64
          tar -czf scorex-${{ steps.version.outputs.VERSION }}-macos-x86_64.tar.gz scorex-macos-x86_64
          zip scorex-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip scorex-windows-x86_64.exe

          # Generate checksums
          sha256sum *.tar.gz *.zip > checksums.txt

      - name: Create Release
        # Only create actual release on tag push
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/scorex-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz
            release/scorex-${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz
            release/scorex-${{ steps.version.outputs.VERSION }}-macos-x86_64.tar.gz
            release/scorex-${{ steps.version.outputs.VERSION }}-windows-x86_64.zip
            release/checksums.txt
          generate_release_notes: true
          draft: false
          prerelease: false

      - name: Upload test artifacts
        # Upload artifacts for PRs and manual runs
        if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: scorex-test-binaries-${{ steps.version.outputs.VERSION }}
          path: release/*
          retention-days: 7
