# *******************************************************************************
# Copyright (c) 2025 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0
#
# SPDX-License-Identifier: Apache-2.0
# *******************************************************************************
name: Scrample Build CLI
on:
  pull_request:
    types: [opened, reopened, synchronize]
  merge_group:
    types: [checks_requested]
jobs:
  gazelle-and-go-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true

      - name: Run Gazelle
        run: bazel run //:gazelle

      - name: Set version
        id: version
        run: |
          # Get short commit SHA
          SHORT_SHA=$(git rev-parse --short HEAD)
          # Create version string
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            VERSION="pr-${{ github.event.pull_request.number }}-${SHORT_SHA}"
          else
            VERSION="${SHORT_SHA}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build scorex for all platforms
        run: |
          VERSION=${{ steps.version.outputs.VERSION }} bazel build \
            //scorex:scorex_linux_amd64 \
            //scorex:scorex_darwin_arm64 \
            //scorex:scorex_windows_amd64

      - name: Copy binaries to artifacts
        run: |
          mkdir -p artifacts

          # Use bazel cquery to find actual output paths (bazel-bin symlink is cleared for multi-platform builds)
          echo "Finding binary locations..."
          LINUX_BIN=$(bazel cquery --output=files //scorex:scorex_linux_amd64 2>/dev/null)
          DARWIN_ARM64_BIN=$(bazel cquery --output=files //scorex:scorex_darwin_arm64 2>/dev/null)
          WINDOWS_BIN=$(bazel cquery --output=files //scorex:scorex_windows_amd64 2>/dev/null)

          echo "Linux binary: $LINUX_BIN"
          echo "macOS ARM64 binary: $DARWIN_ARM64_BIN"
          echo "Windows binary: $WINDOWS_BIN"

          # Copy binaries
          if [ -f "$LINUX_BIN" ]; then
            cp "$LINUX_BIN" artifacts/scorex-linux-x86_64
            echo "✓ Linux binary copied"
          else
            echo "ERROR: Linux binary not found at $LINUX_BIN"
            exit 1
          fi

          if [ -f "$DARWIN_ARM64_BIN" ]; then
            cp "$DARWIN_ARM64_BIN" artifacts/scorex-macos-arm64
            echo "✓ macOS ARM64 binary copied"
          else
            echo "ERROR: macOS ARM64 binary not found"
            exit 1
          fi

          if [ -f "$WINDOWS_BIN" ]; then
            cp "$WINDOWS_BIN" artifacts/scorex-windows-x86_64.exe
            echo "✓ Windows binary copied"
          else
            echo "ERROR: Windows binary not found"
            exit 1
          fi

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scorex-linux
          path: artifacts/scorex-linux-x86_64
          if-no-files-found: error

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scorex-macos
          path: artifacts/scorex-macos-arm64
          if-no-files-found: error

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scorex-windows
          path: artifacts/scorex-windows-x86_64.exe
          if-no-files-found: error
